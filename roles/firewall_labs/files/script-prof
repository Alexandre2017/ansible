#!/bin/bash

WAN=eth0
#LAB=redes
echo -n "Qual laboratório: "
read LAB

#timeout 0.1 nc -z -w5 $ip 22 testar porta 22
# se == 1, porta nao liberada
# se == 124, ip nao responde
# se == 0 , OK
testa_ping(){
    target=${1}
    timeout 1 ping -q -i 0.2 -c2 ${target} > /dev/null 2>&1
    teste="$?"
    if [ ${teste} = "0" ] ; then
        echo "${target} is UP!"
#        ssh root@${target} "grub-reboot 2 && reboot"
#        ssh root@${target} poweroff
#        ssh root@${target} "$(typeset -f ${comando}); ${comando}"
    else
        echo "${target} is DOWN!"
    fi
}

#limpa(){
#    cat << EOF
#    # Generated by iptables-save v1.6.0 on Mon Feb 11 16:04:53 2019
#    *filter
#    :INPUT ACCEPT [107:24295]
#    :FORWARD ACCEPT [0:0]
#    :OUTPUT ACCEPT [100:19398]
#    COMMIT
#    # Completed on Mon Feb 11 16:04:53 2019
#    # Generated by iptables-save v1.6.0 on Mon Feb 11 16:04:53 2019
#    *nat
#    :PREROUTING ACCEPT [16:2678]
#    :INPUT ACCEPT [8:1238]
#    :OUTPUT ACCEPT [4:270]
#    :POSTROUTING ACCEPT [4:270]
#    COMMIT
#    # Completed on Mon Feb 11 16:04:53 2019
#EOF
#}
#
#minimo(){
#    iptables -t filter -A INPUT -i lo -j ACCEPT
#    iptables -t filter -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
#}
#
#bloqueia(){
#    limpa
#    minimo
#    cat << EOF
#    # Generated by iptables-save v1.6.0 on Mon Feb 11 15:54:57 2019
#    *filter
#    :INPUT ACCEPT [0:0]
#    :FORWARD ACCEPT [0:0]
#    :OUTPUT ACCEPT [0:0]
#    -A INPUT -i lo -j ACCEPT
#    -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
#    -A INPUT -j DROP
#    -A OUTPUT -j DROP
#    COMMIT
#    # Completed on Mon Feb 11 15:54:57 2019
#    # Generated by iptables-save v1.6.0 on Mon Feb 11 15:54:57 2019
#    *nat
#    :PREROUTING ACCEPT [2269:548214]
#    :INPUT ACCEPT [25:4276]
#    :OUTPUT ACCEPT [753:133146]
#    :POSTROUTING ACCEPT [1:76]
#    -A POSTROUTING -d 191.36.8.3/32 -o eth0 -j MASQUERADE
#    -A POSTROUTING -d 191.36.8.16/32 -o eth0 -j MASQUERADE
#    -A POSTROUTING -d 191.36.8.37/32 -o eth0 -j MASQUERADE
#    -A POSTROUTING -o eth0 -p udp -j MASQUERADE
#    -A POSTROUTING -o eth0 -p icmp -j MASQUERADE
#    COMMIT
#    # Completed on Mon Feb 11 15:54:57 2019}
#EOF
#quartus(){
#    limpa
#    minimo
#    cat << EOF
#    # Generated by iptables-save v1.6.0 on Mon Feb 11 16:07:50 2019
#    *filter
#    :INPUT ACCEPT [0:0]
#    :FORWARD ACCEPT [0:0]
#    :OUTPUT ACCEPT [0:0]
#    -A INPUT -j DROP
#    -A OUTPUT -j DROP
#    COMMIT
#    # Completed on Mon Feb 11 16:07:50 2019
#    # Generated by iptables-save v1.6.0 on Mon Feb 11 16:07:50 2019
#    *nat
#    :PREROUTING ACCEPT [10:1868]
#    :INPUT ACCEPT [4:750]
#    :OUTPUT ACCEPT [0:0]
#    :POSTROUTING ACCEPT [0:0]
#    -A POSTROUTING -d 191.36.8.3/32 -o eth0 -j MASQUERADE
#    -A POSTROUTING -d 172.18.110.2/32 -o eth0 -p tcp -j MASQUERADE
#    -A POSTROUTING -o eth0 -p udp -j MASQUERADE
#    -A POSTROUTING -o eth0 -p icmp -j MASQUERADE
#    COMMIT
#    # Completed on Mon Feb 11 16:07:50 2019
#EOF
#}

if [ ${LAB} = "sidi" ] ; then
  ##Maquinas do SiDi
  maquinas=(703872 703873 703874 703875 703876 703877 703878 703879 703880 703881 703882 703883 703884 703885 744600 744603 744604 744605 744606 744609 756046 756047 756048 756049 756050)
elif [ ${LAB} = "prog" ] ; then
  ##Maquinas do prog
  maquinas=(38111 38125 744522 744523 744527 744531 744532 744534 744535 744537 744538 744601 744602 744607 756043 756045 756051 866459 866460 866461 866462 866463 866464 866465 866466)
elif [ ${LAB} = "redes" ] ; then
  ## Maquinas do redes
  maquinas=(38103 38106 38107 38109 38110 38114 38115 38116 38117 38118 38119 38120 38123 38126 38127 38128 38130 38131 38132 38135 38136 613025 710812 744530)
elif [ ${LAB} = "cad1" ] ; then
  ## Maquinas do cad1
  maquinas=(37247 38097 38108 38133 38310 38844 38854 565463 608618 6wkdxp1 744515 744517 744519 744526 744539 7nhdqn1 brg250fhqx brg250fhsc bskdxp1 clhdqn1 fskdxp1)
elif [ ${LAB} = "cad2" ] ; then
  ## Maquinas do cad2
  maquinas=(38841 38842 38847 38851 38852 710789 710801 710804 710805 710806 710809 710811 710817 710819 710823)
elif [ ${LAB} = "cad3" ] ; then
  ## Maquinas do cad3
  maquinas=(38096 38098 38099 38100 38101 38102 744389 744390 744391 744392 744394 744395 744397 744402 744403 744528 744536 756052 7vkdxp1 hskdxp1 jvkdxp1)
else
  echo "Não existe um laboratório chamado ${LAB}."
fi

#if [ $# -ne 1 ];
#    then
#        echo "Sintaxe errada. Exemplo:"
#        echo ".$0 (limpa|bloqueia)"
#        exit
#fi

# Testa se a maquina esta na rede e executa o comando do firewall
comando=${1}
for line in ${maquinas[@]}; do
    testa_ping sj-lin-${LAB}-${line}.maquinas.sj.ifsc.edu.br
done
